<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üèÅ Angry Dynomites Race Replay</title>
  <style>
    body {
      background-color: #1e1e1e;
      font-family: 'Orbitron', sans-serif;
      color: #fff;
      margin: 0;
      padding: 2rem;
      overflow: hidden;
    }
    h1 { text-align: center; color: #f39c12; margin-bottom: 20px; }
    #controls { text-align: center; margin-bottom: 20px; }
    #leaderboard { position: relative; width: 90%; max-width: 1000px; margin: 0 auto; height: 800px; }

    .player-bar {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      display: flex;
      align-items: center;
      background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
      border: 2px solid #8e44ad;
      border-radius: 12px;
      padding: 10px;
      transition: transform 0.8s ease, background 0.5s ease;
      opacity: 0;
      animation: dropIn 0.6s forwards;
    }
    .first { background: linear-gradient(135deg, #ffd700, #ff8c00); border: 3px solid gold; animation: pulseGold 2s infinite alternate, dropIn 0.6s forwards; }
    .second { background: linear-gradient(135deg, #c0c0c0, #808080); border: 3px solid silver; animation: pulseSilver 2s infinite alternate, dropIn 0.6s forwards; }
    .third { background: linear-gradient(135deg, #cd7f32, #8b4513); border: 3px solid #cd7f32; animation: pulseBronze 2s infinite alternate, dropIn 0.6s forwards; }

    .position-button {
      transform: rotate(-10deg);
      margin-right: 10px;
      background: #8e44ad;
      border: none;
      color: #fff;
      font-weight: bold;
      border-radius: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }

    .avatar-wrapper { width: 60px; height: 60px; overflow: hidden; border-radius: 50%; }
    .avatar { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
    .avatar-wrapper:hover .avatar { transform: scale(0.9) rotate(5deg); }

    .bar-wrapper {
      flex-grow: 1;
      background-color: rgba(50, 56, 56, 0.25);
      border-radius: 8px;
      margin-left: 1rem;
      position: relative;
      height: 60px;
      overflow: hidden;
    }
    .bar {
      height: 100%;
      background-image: url('asset/generative-art=2.gif');
      background-size: cover;
      border-radius: 8px;
      width: 0;
      transition: width 1s ease;
    }

    .name-label { width: 120px; margin-left: 10px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .points { margin-left: 1rem; font-size: 1.1rem; font-weight: bold; }

    @keyframes dropIn { from { opacity: 0; transform: translateX(-50%) translateY(-50px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes fallForward { 0% { transform: translateX(-50%) rotateX(0deg); } 30% { transform: translateX(-50%) rotateX(45deg); } 100% { transform: translateX(-50%) rotateX(0deg); } }

    .falling { animation: fallForward 0.6s ease; }

    @keyframes pulseGold { 0% { box-shadow: 0 0 10px gold; } 100% { box-shadow: 0 0 20px gold; } }
    @keyframes pulseSilver { 0% { box-shadow: 0 0 10px silver; } 100% { box-shadow: 0 0 20px silver; } }
    @keyframes pulseBronze { 0% { box-shadow: 0 0 10px #cd7f32; } 100% { box-shadow: 0 0 20px #cd7f32; } }
  </style>
</head>

<body>

<h1>üèéÔ∏è Angry Dynomites Race Replay</h1>
<div id="controls">
  <button onclick="setSpeed(1)">1x</button>
  <button onclick="setSpeed(2)">2x</button>
  <button onclick="setSpeed(4)">4x</button>
</div>
<div id="leaderboard"></div>

<script>
let snapshots = [];
let leaderboardState = {};
let currentFrame = 0;
let frameDuration = 1500;

async function loadLatestHighlight() {
  const response = await fetch('http://localhost:8080/api/latest-highlight-id');
  const data = await response.json();
  await loadSnapshots(data.masterpieceId);
}

async function loadSnapshots(masterpieceId) {
  const response = await fetch(`http://localhost:8080/api/highlight-snapshots/${masterpieceId}`);
  snapshots = await response.json();
  startReplay();
}

function startReplay() {
  if (!snapshots.length) return;
  currentFrame = 0;
  updateLeaderboard(snapshots[currentFrame]);
  animateNextFrame();
}

function animateNextFrame() {
  setTimeout(() => {
    currentFrame++;
    if (currentFrame >= snapshots.length) {
      showFinishScreen();
      return;
    }
    updateLeaderboard(snapshots[currentFrame]);
    animateNextFrame();
  }, frameDuration);
}

function showFinishScreen() {
  document.getElementById('leaderboard').innerHTML = '<h1>üèÅ Race Finished!</h1>';
}

function updateLeaderboard(snapshotObj) {
  const players = snapshotObj.data.leaderboard.sort((a, b) => b.masterpiecePoints - a.masterpiecePoints);

  players.forEach((player, index) => {
    const id = player.profile.displayName.replace(/\s+/g, '-');

    if (!leaderboardState[id]) {
      leaderboardState[id] = {
        points: 0,
        targetPoints: player.masterpiecePoints,
        rank: index,
        avatarUrl: player.profile.avatarUrl || 'asset/default-avatar.gif',
        name: player.profile.displayName,
      };
      createPlayerEntry(id);
    } else {
      leaderboardState[id].targetPoints = player.masterpiecePoints;
      leaderboardState[id].prevRank = leaderboardState[id].rank;
      leaderboardState[id].rank = index;
    }
  });

  repositionPlayers();
}

function createPlayerEntry(id) {
  const player = leaderboardState[id];
  const container = document.getElementById('leaderboard');

  const div = document.createElement('div');
  div.className = 'player-bar';
  div.id = `player-${id}`;
  div.innerHTML = `
    <button class="position-button">0</button>
    <div class="avatar-wrapper">
      <img class="avatar" src="${parseAvatar(player.avatarUrl)}" alt="Avatar">
    </div>
    <div class="name-label">${player.name}</div>
    <div class="bar-wrapper"><div class="bar"></div></div>
    <span class="points">0 pts</span>
  `;

  container.appendChild(div);
}

function repositionPlayers() {
  Object.keys(leaderboardState).forEach(id => {
    const player = leaderboardState[id];
    const div = document.getElementById(`player-${id}`);
    if (!div) return;

    div.style.transform = `translateX(-50%) translateY(${player.rank * 90}px)`;

    const posBtn = div.querySelector('.position-button');
    posBtn.textContent = player.rank + 1;

    const bar = div.querySelector('.bar');
    bar.style.width = Math.min((player.points / 10000) * 100, 100) + '%';

    const pointsEl = div.querySelector('.points');
    pointsEl.textContent = Math.floor(player.points) + ' pts';

    if (player.prevRank !== undefined && player.rank > player.prevRank) {
      div.classList.add('falling');
      setTimeout(() => div.classList.remove('falling'), 600);
    }
  });

  animatePoints();
}

function animatePoints() {
  Object.keys(leaderboardState).forEach(id => {
    const player = leaderboardState[id];
    const diff = player.targetPoints - player.points;
    if (Math.abs(diff) > 1) player.points += diff * 0.1;
    else player.points = player.targetPoints;
  });

  repositionPlayers();
  requestAnimationFrame(animatePoints);
}

function parseAvatar(url) {
  if (!url) return 'asset/default-avatar.gif';
  if (url.startsWith('ipfs://')) return url.replace('ipfs://', 'https://ipfs.io/ipfs/');
  return url;
}

function setSpeed(multiplier) {
  frameDuration = 1500 / multiplier;
}

loadLatestHighlight();
</script>

</body>
</html>
