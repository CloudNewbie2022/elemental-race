<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Current Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 20px; }
    #leaderboard { margin-top: 20px; }
    .entry { margin-bottom: 10px; }
    .back-button { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Current Leaderboard</h1>
  <div id="leaderboard">Loading...</div>
  <button class="back-button" onclick="window.location.href='original.html'">Back to Main Page</button>

  <script src="leaderboard.js"></script>
</body>
</html>
<script>
  async function fetchCurrentLeaderboard() {
    try {
      const response = await fetch('/graphql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: `
            query {
              masterpieces(filter: { eventId: null }) {
                id
                name
                leaderboard {
                  profile {
                    displayName
                    avatarUrl
                  }
                  masterpiecePoints
                }
              }
            }
          `
        })
      });

      if (!response.ok) throw new Error('Network response was not ok.');

      const liveData = await response.json();
      const masterpieces = liveData.data.masterpieces;

      if (!masterpieces || masterpieces.length === 0) {
        console.error('No active masterpieces with null eventId');
        return;
      }

      // Optionally grab the first one
      const leaderboardData = masterpieces[0].leaderboard
        .sort((a, b) => b.masterpiecePoints - a.masterpiecePoints)
        .slice(0, 10); // Top 10

      displayLeaderboard(leaderboardData);
    } catch (error) {
      console.error('Fetch error:', error);
    }
  }

  function displayLeaderboard(leaderboardData) {
    const leaderboardEl = document.getElementById('leaderboard');
    leaderboardEl.innerHTML = '';

    const maxPoints = Math.max(...leaderboardData.map(p => p.masterpiecePoints));

    leaderboardData.forEach(player => {
      const wrapper = document.createElement('div');
      wrapper.className = 'player-bar';

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = player.profile.avatarUrl || 'asset/default-avatar.webp';
      avatar.onerror = () => {
        avatar.src = 'asset/default-avatar.webp';
      };

      const barWrapper = document.createElement('div');
      barWrapper.className = 'bar-wrapper';

      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.width = `${(player.masterpiecePoints / maxPoints) * 100}%`;

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = `${player.profile.displayName} (${player.masterpiecePoints} pts)`;

      barWrapper.appendChild(bar);
      wrapper.appendChild(avatar);
      wrapper.appendChild(barWrapper);
      wrapper.appendChild(label);
      leaderboardEl.appendChild(wrapper);
    });
  }

  document.addEventListener('DOMContentLoaded', fetchCurrentLeaderboard);
</script>
